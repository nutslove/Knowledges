- https://inuplace.tistory.com/602
- https://losskatsu.github.io/it-infra/django-inspectdb/#1-db-%ED%85%8C%EC%9D%B4%EB%B8%94-%EC%9E%A5%EA%B3%A0%EB%A1%9C-%EB%B6%88%EB%9F%AC%EC%98%A4%EA%B8%B0

## models.pyを修正した後にDBに反映する方法
- Djangoをコンテナで動かしてる場合はDjangoコンテナに入る
- `python3 manage.py makemigrations <アプリ名>`を実行
  - e.g. `python3 manage.py makemigrations privilege`
- `python3 manage.py migrate <アプリ名>`を実行
  - e.g. `python3 manage.py migrate privilege`

## views.pyでModelで定義したテーブルデータを操作する方法
- views.pyにて`from .models import <Model名>[, <Model名>, <Model名>,・・・]`でModelをimport
  - 例えば、作成したModelが「System」,「Dbuserpassword」,「Userprivilegestate」３つの場合、`from .models import System, Dbuserpassword, Userprivilegestate`
- `<Model名>.objects.get(<カラム名>=<検索値>)`
- **https://office54.net/python/django/orm-database-operate**
- https://qiita.com/NOIZE/items/a50afe3af644a55d37e7


### DjangoのModelとDBデータ型のマッピング
- https://qiita.com/okoppe8/items/13ad7b7d52fd6a3fd3fc

### Modelで`primary_key=True`を指定しない場合、Djangoが自動的に`id`というPrimary Keyを作成する
- https://docs.djangoproject.com/en/4.2/topics/db/models/#automatic-primary-key-fields
- `SELECT nextval('<テーブル名>_id_seq');`で次に振られるid番号を確認できる
  - `privilege_userprivilegestate`というテーブルで次のidを取得する場合、`SELECT nextval('privilege_userprivilegestate_id_seq');`
- 以下のように`primary_key=True`のないModelで作成した時、作成されるDBテーブル例
  - Django側(models.py)
    ~~~python
    from django.db import models

    # Create your models here.
    class Userprivilegestate(models.Model):
      userid = models.CharField(max_length=30, help_text='ユーザID')
      combinationid = models.ForeignKey(Dbuserpassword, on_delete=models.CASCADE)
      endtimestamp = models.DateTimeField(help_text='特権利用終了日時')

      class Meta:
        constraints = [
            models.UniqueConstraint(fields=['userid', 'combinationid'], name='unique_user')
        ]
    ~~~
  - DB側
    ~~~
    postgres=> \d privilege_userprivilegestate
                              Table "public.privilege_userprivilegestate"
      Column      |           Type           | Collation | Nullable |             Default
    ------------------+--------------------------+-----------+----------+----------------------------------
    id               | bigint                   |           | not null | generated by default as identity
    userid           | character varying(30)    |           | not null |
    endtimestamp     | timestamp with time zone |           | not null |
    combinationid_id | character varying(30)    |           | not null |
    Indexes:
        "privilege_userprivilegestate_pkey" PRIMARY KEY, btree (id)
        "unique_user" UNIQUE CONSTRAINT, btree (userid, combinationid_id)
        "privilege_userprivilegestate_combinationid_id_d9d618ef" btree (combinationid_id)
        "privilege_userprivilegestate_combinationid_id_d9d618ef_like" btree (combinationid_id varchar_pattern_ops)
    Foreign-key constraints:
        "privilege_userprivil_combinationid_id_d9d618ef_fk_privilege" FOREIGN KEY (combinationid_id) REFERENCES privilege_dbuserpassword(combinationid) DEFERRABLE INITIALLY DEFERRED
    ~~~

### Djangoには復号主キー機能はないらしい
- https://zenn.dev/shimakaze_soft/scraps/22dcea1acd133a
- その代わりに、複合ユニーク制約の機能を使う

## Modelから作成されたTableを削除した場合、再migrationする方法
1. `django_migrations`テーブルからアプリ名のレコードを削除
   - 削除したいアプリのidが19の場合
     - `delete from django_migrations where id = 19;`
2. Modelから作成したテーブルを`DROP TABLE <テーブル名>;`ですべて削除する
3. `<アプリ名>/migrations`フォルダをフォルダごと削除する
4. `python manage.py makemigrations <アプリ名>`を実行
5. `python manage.py migrate <アプリ名>`を実行
 
- 参考URL
  - https://stackoverflow.com/questions/33259477/how-to-recreate-a-deleted-table-with-django-migrations