- å‚è€ƒURL
  - https://python.langchain.com/docs/how_to/hybrid/
  - https://dalab.jp/archives/journal/hybrid-search/
  - https://qiita.com/isanakamishiro2/items/4eb175bb2bc80d7225cb
  - https://qiita.com/jw-automation/items/045917be7b558509fdf2#1-%E3%83%8F%E3%82%A4%E3%83%96%E3%83%AA%E3%83%83%E3%83%89%E3%82%B5%E3%83%BC%E3%83%81

## ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ï¼ˆSemantic Searchï¼‰ã¨ã¯
- ã‚¯ã‚¨ãƒªã®å˜èªã«æ–‡å­—é€šã‚Šä¸€è‡´ã™ã‚‹å†…å®¹ã§ã¯ãªãã€å˜ç´”ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ã§ã¯ãªãã€Œæ„å‘³çš„ã«é–¢é€£ã™ã‚‹æƒ…å ±ã€ã‚’æ¢ã™æ¤œç´¢æ‰‹æ³•ã®ç·ç§°
  - ãã®ä»£è¡¨çš„ãªå®Ÿè£…ãŒ **ã€Œãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã€** ã§ã€**ãƒ†ã‚­ã‚¹ãƒˆã‚’åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›ã—ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã‚„å†…ç©ãªã©ã§è¿‘ã„ã‚‚ã®ã‚’æ¢ã™ã€‚**
- å‚è€ƒURL
  - **https://www.elastic.co/jp/what-is/semantic-search**
  - https://boramorka.github.io/LLM-Book/CHAPTER-2/2.5%20Semantic%20Search.%20Advanced%20Retrieval%20Strategies/
  - https://aws.amazon.com/jp/blogs/news/knowledge-bases-for-amazon-bedrock-now-supports-hybrid-search/
  - https://aws.amazon.com/jp/blogs/news/amazon-opensearch-services-vector-database-capabilities-explained/
- **ã€Œãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã€ã¯ã€Œã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã€ã®ä¸€ç¨®ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ âŠ‚ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ï¼‰**
  - https://www.elastic.co/jp/what-is/vector-search  
    > ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯ã€ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã‚„é¡ä¼¼æ€§æ¤œç´¢ã«å¨åŠ›ã‚’ç™ºæ®ã—ã¾ã™ã€‚æ„å‘³ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒåŸ‹ã‚è¾¼ã¿å†…ã«å–ã‚Šè¾¼ã¾ã‚Œã‚‹ãŸã‚ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å®Œå…¨ä¸€è‡´ã‚’å¿…è¦ã¨ã›ãšã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å‘³ã™ã‚‹å†…å®¹ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ã€ç”»åƒã€éŸ³å£°ã®å‡¦ç†ãŒå¯èƒ½ã§ã™ã€‚ã‚¯ã‚¨ãƒªã«é¡ä¼¼ã¾ãŸã¯é–¢é€£ã™ã‚‹è£½å“ã‚’ç°¡å˜ã‹ã¤è¿…é€Ÿã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
  - https://www.elastic.co/jp/what-is/semantic-search  
    > ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã¯ [ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢](https://www.elastic.co/jp/what-is/vector-search) ã‚’æ´»ç”¨ã—ã¦ãŠã‚Šã€ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆã‚„æ¤œç´¢æ„å›³ã®é–¢é€£æ€§ã«åŸºã¥ã„ã¦ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ©ãƒ³ã‚¯ä»˜ã‘ã—ã¦ä¾›çµ¦ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯ã€æ¤œç´¢å¯èƒ½ãªæƒ…å ±ã®è©³ç´°ã‚’é–¢é€£ã™ã‚‹ç”¨èªã‚„é …ç›®ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ã‚ã‚‹ã„ã¯è¤‡æ•°ã®ãƒ™ã‚¯ãƒˆãƒ«ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã€æ¬¡ã«å„ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ¯”è¼ƒã—ã¦ã©ã‚ŒãŒæœ€ã‚‚ã‚ˆãä¼¼ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¾ã™ã€‚
    > 
    > ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å¯¾å¿œã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã§ã¯ã€ã‚¯ã‚¨ãƒªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¸¡ç«¯ã§åŒæ™‚ã«ä½œå‹•ã—ã¦çµæœã‚’å‡ºã—ã¾ã™ã€‚ã‚¯ã‚¨ãƒªãŒç™ºã›ã‚‰ã‚ŒãŸã‚‰ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¯ãã®ã‚¯ã‚¨ãƒªã‚’åŸ‹ã‚è¾¼ã¿ã«å¤‰æ›ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼‰ã—ã¾ã™ã€‚ã™ãªã‚ã¡ãƒ‡ãƒ¼ã‚¿ã¨é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆã®æ•°å€¤è¡¨ç¾ã«å¤‰æ›ã™ã‚‹ã®ã§ã™ã€‚ã“ã®å€¤ã¯ãƒ™ã‚¯ãƒˆãƒ«ã§ä¿ç®¡ã•ã‚Œã¾ã™ã€‚æ¬¡ã« [kNNã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆã¾ãŸã¯kè¿‘å‚æ³•ï¼‰](https://www.elastic.co/jp/what-is/knn) ã‚’ä½¿ã£ã¦ã€æ—¢å­˜æ–‡æ›¸ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ãŒé–¢ä¸ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ã€ã‚¯ã‚¨ãƒªã®ãƒ™ã‚¯ãƒˆãƒ«ã¨ç…§åˆã—ã¾ã™ã€‚æ¬¡ã«ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã¯çµæœã‚’ç”Ÿæˆã—ã€æ¦‚å¿µçš„ãªé–¢é€£æ€§ã«åŸºã¥ã„ã¦ãã®çµæœã‚’ãƒ©ãƒ³ã‚¯ä»˜ã‘ã—ã¾ã™ã€‚
    > 
    > ï¼‘. ã‚¯ã‚¨ãƒªãŒç™ºã›ã‚‰ã‚ŒãŸã‚‰ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¯ãã®ã‚¯ã‚¨ãƒªã‚’åŸ‹ã‚è¾¼ã¿ã«å¤‰æ›ï¼ˆãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼‰ã—ã¾ã™ã€‚ã™ãªã‚ã¡ãƒ‡ãƒ¼ã‚¿ã¨é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆã®æ•°å€¤è¡¨ç¾ã«å¤‰æ›ã™ã‚‹ã®ã§ã™ã€‚ã“ã®å€¤ã¯ãƒ™ã‚¯ãƒˆãƒ«ã§ä¿ç®¡ã•ã‚Œã¾ã™ã€‚
    >
    > ï¼’. æ¬¡ã«kNNã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆã¾ãŸã¯kè¿‘å‚æ³•ï¼‰ã‚’ä½¿ã£ã¦ã€æ—¢å­˜æ–‡æ›¸ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ãŒé–¢ä¸ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ã€ã‚¯ã‚¨ãƒªã®ãƒ™ã‚¯ãƒˆãƒ«ã¨ç…§åˆã—ã¾ã™ã€‚
    >
    > ï¼“. æ¬¡ã«ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã¯çµæœã‚’ç”Ÿæˆã—ã€æ¦‚å¿µçš„ãªé–¢é€£æ€§ã«åŸºã¥ã„ã¦ãã®çµæœã‚’ãƒ©ãƒ³ã‚¯ä»˜ã‘ã—ã¾ã™ã€‚

---

## Hybrid Searchã¨ã¯
- åŸºæœ¬çš„ã«ã¯ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦ã«ã‚ˆã‚Šã€ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‹ã‚‰æ¤œç´¢ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰ãŒè¡Œã‚ã‚Œã‚‹ã‘ã©ã€ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦æ¤œç´¢ã¨ä»–ã®æ¤œç´¢æ‰‹æ³•ï¼ˆå…¨æ–‡æ¤œç´¢ã€BM25ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ãªã©ï¼‰ã‚’çµ„ã¿åˆã‚ã›ã¦ã€ã‚ˆã‚Šé«˜åº¦ãªæ¤œç´¢ã‚’è¡Œã†æ–¹å¼ã‚’**Hybrid Search**ã¨ã„ã†
  - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ¤œç´¢ã®æ–¹æ³•ã¯ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã«ã‚ˆã£ã¦ç•°ãªã‚‹
- è¤‡æ•°ã®æ¤œç´¢æ–¹å¼ã«ã‚ˆã£ã¦å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã¦æœ€ã‚‚é©åˆæ€§ã®é«˜ã„çµæœã‚’è¿”ã™
  - BM25ã‚¹ã‚³ã‚¢ã¨ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’çµ±åˆã—ãŸã‚Šã€ç‰‡æ–¹ã§å€™è£œã‚’çµã£ã¦ã‚‚ã†ç‰‡æ–¹ã§å†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã—ãŸã‚Š
- AWSã®Knowledge Basesã§ã®Hybrid Searchã¯ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã€ã¨ã€Œã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã€ã®çµ„ã¿åˆã‚ã›
  - https://aws.amazon.com/jp/blogs/news/knowledge-bases-for-amazon-bedrock-now-supports-hybrid-search/

### å…¨æ–‡æ¤œç´¢ã¨BM25
- å…¨æ–‡æ¤œç´¢ã¨BM25ã¯åŒç¾©èªã§ã¯ãªãã€BM25ã¯ã€å…¨æ–‡æ¤œç´¢ã®ä¸­ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹ã€Œã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ‰‹æ³•ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰ã€ã®ä¸€ã¤
  - ã¤ã¾ã‚Šã€Œå…¨æ–‡æ¤œç´¢ã€ âŠƒ ã€ŒBM25ã€

### BM25
- ã€ŒBest Matching 25ã€ã®ç•¥ã§ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ãŒã€Œã©ã®æ–‡æ›¸ãŒæ¤œç´¢ã‚¯ã‚¨ãƒªã«æœ€ã‚‚é–¢é€£ã—ã¦ã„ã‚‹ã‹ã€ã‚’æ•°å€¤ã§è©•ä¾¡ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- **TFï¼ˆå˜èªã®å‡ºç¾å›æ•°ï¼‰**ã€**IDFï¼ˆå˜èªã®é€†æ–‡æ›¸é »åº¦ï¼‰**ã€**æ–‡æ›¸ã®é•·ã•ã®æ­£è¦åŒ–**ã‚’çµ„ã¿åˆã‚ã›ã¦è¨ˆç®—ã™ã‚‹ã€‚
- ä¾‹ãˆã°ã€å˜èªAãŒå«ã¾ã‚Œã‚‹æ–‡æ›¸ã‚’æ¢ã—ã¤ã¤ã€ã€Œå‡ºç¾é »åº¦ãŒå¤šã„ã€,ã€Œæ–‡æ›¸ãŒçŸ­ã„ã€ãªã©ã®è¦ç´ ã§ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã€é–¢é€£åº¦ã®é«˜ã„é †ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã™ã‚‹ã€‚
- ç¾ä»£ã®å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆElasticsearchã€OpenSearchã€Luceneãªã©ï¼‰ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„ã€‚

#### â˜…BM25ã®å†…éƒ¨å‡¦ç†ã®æµã‚Œ
1. **ã‚¯ã‚¨ãƒªã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†å‰²ï¼ˆãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºï¼‰**
   - ã¾ãšæ¤œç´¢å¯¾è±¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚¯ã‚¨ãƒªãƒ¼ã®ä¸¡æ–¹ã‚’å˜èªå˜ä½ã«åˆ†å‰²ï¼ˆï¼ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºï¼‰
   - æ™®é€šã¯ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã•ã‚Œã‚‹ãŒã€æ—¥æœ¬èªã®å ´åˆã¯ã‚¹ãƒšãƒ¼ã‚¹ãŒãªã„ã®ã§ã€å½¢æ…‹ç´ è§£æå™¨ï¼ˆMeCabã€Sudachiãªã©ï¼‰ã‚’ä½¿ã£ã¦åˆ†å‰²ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   ```graphql
   ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: "ç§ã¯çŒ«ãŒå¥½ãã§ã™"
   ã‚¯ã‚¨ãƒª: "çŒ« å¥½ã"
   â†“
   Doc tokens: ["ç§", "ã¯", "çŒ«", "ãŒ", "å¥½ã", "ã§ã™"]
   Query tokens: ["çŒ«", "å¥½ã"]
   ```
2. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆInverted Indexï¼‰**
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå´ã®å˜èªã”ã¨ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆï¼ˆã€Œé€†å¼•ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆInverted Indexï¼‰ã€ã¨å‘¼ã°ã‚Œã‚‹ï¼‰

> [!TIP]  
> **é€†å¼•ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆInverted Indexï¼‰** ã¨ã¯ã€**ã€Œå˜èª â†’ ãã®å˜èªã‚’å«ã‚€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§ã€** ã‚’å¯¾å¿œä»˜ã‘ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€‚  
> æ™®é€šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæ­£å¼•ãã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹, Forward Indexï¼‰ãŒã€Œãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â†’ å«ã¾ã‚Œã‚‹å˜èªã€ã§ã‚ã‚‹ã®ã«å¯¾ã—ã€  
> è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆInverted Indexï¼‰ã¯ã€Œå˜èª â†’ å«ã¾ã‚Œã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ã‚’è¨˜éŒ²ã™ã‚‹ã€‚
> ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã£ãŸå ´åˆï¼š
> ```vbnet
> Doc1: "çŒ« ãŒ çŒ« ã‚’ è¿½ã„ã‹ã‘ã‚‹"
> Doc2: "çŠ¬ ãŒ çŒ« ã‚’ è¦‹ã‚‹"
> Doc3: "çŒ« ãŒ é­š ã‚’ é£Ÿã¹ã‚‹ çŒ«"
> ```
> ã¾ãšã€ãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºï¼ˆå˜èªã«åˆ†å‰²ï¼‰ã‚’è¡Œã†
> | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ãƒˆãƒ¼ã‚¯ãƒ³                 |
> | ------ | -------------------- |
> | Doc1   | [çŒ«, ãŒ, çŒ«, ã‚’, è¿½ã„ã‹ã‘ã‚‹]  |
> | Doc2   | [çŠ¬, ãŒ, çŒ«, ã‚’, è¦‹ã‚‹]     |
> | Doc3   | [çŒ«, ãŒ, é­š, ã‚’, é£Ÿã¹ã‚‹, çŒ«] |
> 
> ãã®å¾Œã€è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆInverted Indexï¼‰ã‚’ä½œæˆã™ã‚‹ã€‚
> 
> | å˜èª  | å‡ºç¾ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ  | å‡ºç¾å›æ•°ï¼ˆTFï¼‰| å‡ºç¾ä½ç½®ï¼ˆposï¼‰|
> | ----- | --------------------------- | ---------------------- | -------------------------------- |
> | çŒ«     | {Doc1: 2, Doc2: 1, Doc3: 2} | Doc1:2, Doc2:1, Doc3:2 | Doc1:[1,3], Doc2:[3], Doc3:[1,6] |
> | ãŒ     | {Doc1: 1, Doc2: 1, Doc3: 1} | Doc1:1, Doc2:1, Doc3:1 | Doc1:[2], Doc2:[2], Doc3:[2]     |
> | ã‚’     | {Doc1: 1, Doc2: 1, Doc3: 1} | Doc1:1, Doc2:1, Doc3:1 | Doc1:[4], Doc2:[4], Doc3:[4]     |
> | è¿½ã„ã‹ã‘ã‚‹ | {Doc1: 1}                   | 1                      | Doc1:[5]                         |
> | çŠ¬     | {Doc2: 1}                   | 1                      | Doc2:[1]                         |
> | è¦‹ã‚‹    | {Doc2: 1}                   | 1                      | Doc2:[5]                         |
> | é­š     | {Doc3: 1}                   | 1                      | Doc3:[3]                         |
> | é£Ÿã¹ã‚‹   | {Doc3: 1}                   | 1                      | Doc3:[5]                         |
>
> æ¬¡ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’è¡Œã†  
> - ã‚¯ã‚¨ãƒªï¼šã€ŒçŒ« ã‚’ã€  
> 1. è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å˜èªã€ŒçŒ«ã€ã¨ã€Œã‚’ã€ã‚’å«ã‚€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
>    - ã€ŒçŒ«ã€â†’ Doc1, Doc2, Doc3
>    - ã€Œã‚’ã€â†’ Doc1, Doc2, Doc3  
>     â†’ ä¸¡æ–¹ã«å«ã¾ã‚Œã‚‹ â†’ Doc1, Doc2, Doc3
>
> 2. å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦ã€ŒçŒ«ã€ã¨ã€Œã‚’ã€ã®å‡ºç¾å›æ•°ã‚’å‚ç…§ã—ã¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
>    - Doc1ï¼šçŒ«=2, ã‚’=1
>    - Doc2ï¼šçŒ«=1, ã‚’=1
>    - Doc3ï¼šçŒ«=2, ã‚’=1  
> BM25ã‚„TF-IDFã¯ã€ã€ŒçŒ«ã€ã®å‡ºç¾å›æ•°ãŒå¤šã„Doc1ã¨Doc3ã‚’é«˜ãè©•ä¾¡ã™ã‚‹å‚¾å‘ãŒã‚ã‚‹  
> â€»BM25ã‚„TF-IDFãªã©ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã§ã¯ã€å˜èªã®å‡ºç¾å›æ•°ãŒã‚¹ã‚³ã‚¢ã«å½±éŸ¿ã™ã‚‹ï¼ˆåŒã˜ã‚¯ã‚¨ãƒªèªãŒè¤‡æ•°å›ç™»å ´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãã®èªã«é–¢ã—ã¦ã‚ˆã‚Šé–¢é€£æ€§ãŒé«˜ã„ã¨ã¿ãªã•ã‚Œã‚‹ï¼‰  
> ãŸã ã€BM25ã§ã¯ã€Œå‡ºç¾å›æ•°ãŒå¤šã™ãã‚‹å ´åˆã¯é£½å’Œã€ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¦ã€å˜ç´”ã«TFãŒå¤šã„ã»ã©ã‚¹ã‚³ã‚¢ãŒç„¡é™ã«ä¸ŠãŒã‚‹ã“ã¨ã¯ãªã„

> [!INFO]  
> - **TFï¼ˆTerm Frequencyï¼‰**
>   - ãã®å˜èªãŒ**1ã¤ã®**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã«ã©ã®ç¨‹åº¦å‡ºç¾ã™ã‚‹ã‹
> - **IDFï¼ˆInverse Document Frequencyï¼‰**
>   - ãã®å˜èªãŒ**å…¨**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸­ã§ã©ã‚Œã ã‘çã—ã„ã‹
>
> ä¾‹ãˆã°ã€å…¨ä½“ã§1000å€‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã¨ã—ãŸå ´åˆã€  
> - ä¾‹1: ã€ŒçŒ«ã€ã¨ã„ã†å˜èª
>   ```
>   ã€ŒçŒ«ã€ã®çµ±è¨ˆ:
>     - Doc1å†…ã§ã®å‡ºç¾: 10å› â†’ TFé«˜ã„ âœ“
>     - å…¨ä½“ã§ã®å‡ºç¾: 1000å€‹ä¸­10å€‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ â†’ IDFé«˜ã„ï¼ˆå¸Œå°‘ï¼‰âœ“
>   ```  
>   - çµæœ: TF Ã— IDF = é«˜ã‚¹ã‚³ã‚¢ ğŸ¯
>     - Doc1ã¯ã€ŒçŒ«ã€ã«ã¤ã„ã¦è©³ã—ãæ›¸ã„ã¦ã„ã‚‹ï¼ˆTFé«˜ï¼‰
>     - ã‹ã¤ã€ŒçŒ«ã€ã¯çã—ã„å˜èªï¼ˆIDFé«˜ï¼‰
>     - â†’ é–¢é€£æ€§ãŒé«˜ã„ï¼
>
> - ä¾‹2: ã€Œã§ã™ã€ã¨ã„ã†å˜èª
>   ```
>   ã€Œã§ã™ã€ã®çµ±è¨ˆ:
>     - Doc1å†…ã§ã®å‡ºç¾: 10å› â†’ TFé«˜ã„ âœ“
>     - å…¨ä½“ã§ã®å‡ºç¾: 990å€‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â†’ IDFä½ã„ï¼ˆã‚ã‚Šãµã‚Œã¦ã„ã‚‹ï¼‰âœ—
>   ```
>   - çµæœ: TF Ã— IDF = ä½ã‚¹ã‚³ã‚¢ ğŸ“‰
>     - Doc1ã«ã¯ã€Œã§ã™ã€ãŒå¤šã„ï¼ˆTFé«˜ï¼‰
>     - ã§ã‚‚ã€Œã§ã™ã€ã¯ã©ã“ã«ã§ã‚‚ã‚ã‚‹ï¼ˆIDFä½ï¼‰
>     - â†’ é‡è¦åº¦ã¯ä½ã„
>
> ```
> TF-IDFã‚¹ã‚³ã‚¢ = TF Ã— IDF
>
> TF = (Docå†…ã§ã®å˜èªã®å‡ºç¾å›æ•°)
> IDF = log(å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•° / ãã®å˜èªã‚’å«ã‚€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°)
>
> ä¾‹1ã€ŒçŒ«ã€:
>   TF = 10
>   IDF = log(1000 / 10) = log(100) â‰ˆ 4.6
>   TF-IDF = 10 Ã— 4.6 = 46
>
> ä¾‹2ã€Œã§ã™ã€:
>   TF = 10
>   IDF = log(1000 / 990) â‰ˆ 0.01
>   TF-IDF = 10 Ã— 0.01 = 0.1
> ```

1. **ã‚¹ã‚³ã‚¢è¨ˆç®—**
   - å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¯¾ã—ã¦ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ãŸæ¤œç´¢æ™‚ã«ã‚¯ã‚¨ãƒªå†…ã®å„å˜èªã®TFï¼ˆå˜èªã®å‡ºç¾é »åº¦ï¼‰ã¨IDFï¼ˆå˜èªã®é€†æ–‡æ›¸é »åº¦ï¼‰ã‚’è¨ˆç®—ã—ã€æ–‡æ›¸ã®é•·ã•ã§æ­£è¦åŒ–ã—ã¦ã€æœ€çµ‚çš„ãªBM25ã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
   - **ã‚¯ã‚¨ãƒªä¸­ã®å˜èªã”ã¨ã®å¯„ä¸ã‚’åˆè¨ˆã—ã¦ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã«å¯¾ã™ã‚‹ã‚¹ã‚³ã‚¢ã‚’ç®—å‡ºã™ã‚‹ï¼ˆå˜èªå˜ä½ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° â†’ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå˜ä½ã§åˆè¨ˆï¼‰**ã€‚ä¾‹ãˆã°ï¼š 
     ```
     ã‚¯ã‚¨ãƒªã€Œæ©Ÿæ¢°å­¦ç¿’ Pythonã€ã®å ´åˆï¼š

     Doc1ã«ã¤ã„ã¦ï¼š
       ã€Œæ©Ÿæ¢°å­¦ç¿’ã€ã®ã‚¹ã‚³ã‚¢: 2.5
       ã€ŒPythonã€ã®ã‚¹ã‚³ã‚¢:   1.8
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Doc1ã®ç·ã‚¹ã‚³ã‚¢:      4.3

     Doc2ã«ã¤ã„ã¦ï¼š
       ã€Œæ©Ÿæ¢°å­¦ç¿’ã€ã®ã‚¹ã‚³ã‚¢: 0.5
       ã€ŒPythonã€ã®ã‚¹ã‚³ã‚¢:   3.2
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Doc2ã®ç·ã‚¹ã‚³ã‚¢:      3.7
     ```

2. **ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆçµæœã®å–å¾—ï¼‰**
   - ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸¦ã¹æ›¿ãˆã€ä¸Šä½Nä»¶ã‚’è¿”ã™
   - BM25ã¯ **ã€Œã‚¯ã‚¨ãƒªã®å˜èªã‚’å¤šãå«ã¿ã€ã‹ã¤å¸Œå°‘ãªå˜èªã‚’å«ã‚€æ–‡æ›¸ã€** ã‚’ **é«˜ãã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã™ã‚‹** ä»•çµ„ã¿

#### LangChainã§ã®BM25Retriever
- å‚è€ƒURL
  - https://python.langchain.com/docs/integrations/retrievers/bm25/
  - https://python.langchain.com/api_reference/community/retrievers/langchain_community.retrievers.bm25.BM25Retriever.html

> [!NOTE]  
> BM25ã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®ä¸€ç¨®ãªã®ã§ã€**VectorStoreä¸Šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®ã‚¯ã‚¨ãƒªãƒ¼ã®ä¸¡æ–¹ã‚’ãƒˆãƒ¼ã‚¯ãƒ³å˜ä½ã«åˆ†å‰²ï¼ˆãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚ºï¼‰** ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
> `BM25Retriever`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€æ–‡ç« ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã¦å‡¦ç†ã™ã‚‹ã€‚è‹±èªã¯ã“ã‚Œã§ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã§ãã‚‹ãŒã€æ—¥æœ¬èªã¯ã§ããªã„ã®ã§ã€`sudachi`ã€`MeCab`ãªã©æ—¥æœ¬èªã®å½¢æ…‹ç´ è§£æå™¨ã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

> [!WARNING]  
> BM25ã¯ã€Œå…¨æ–‡æ¤œç´¢ï¼ˆçµ±è¨ˆçš„ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼‰ã€ã‚’è¡Œã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã€Embeddingãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã¨ã¯é•ã„ã€å‰å‡¦ç†æ¸ˆã¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹é€ ã‚’æŒãŸãªã„é™ã‚Šã€å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸€åº¦ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚
> LangChainã®BM25Retrieverã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ°¸ç¶šåŒ–ã—ãªã„ï¼ˆéƒ½åº¦ä½œã‚Šç›´ã™ï¼‰ãŸã‚ã€ç¾çŠ¶ã§ã¯ã€ŒVectorStoreå†…ã«ã‚ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’éƒ½åº¦å–å¾— â†’ BM25ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œã€ã¨ã„ã†ä»•çµ„ã¿ã¨ãªã£ã¦ãŠã‚Šã€**å¤§é‡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ‰±ã†å ´åˆã€æ¯å›å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¡ãƒ¢ãƒªã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¨æ¤œç´¢ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®é¢ã§æ‚ªå½±éŸ¿ãŒå‡ºã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚**
> 
> **pickleã§BM25ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ°¸ç¶šåŒ–ã—ã¦ã€éƒ½åº¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚**
> - https://zenn.dev/oroshi/articles/langchain-bm25-persist

### LangChainã§ã®Hybrid Search
- `EnsembleRetriever`ã‚¯ãƒ©ã‚¹ã‚’ä½¿ãˆã°ã€è¤‡æ•°ã®Retrieverã‚’çµ„ã¿åˆã‚ã›ã¦Hybrid SearchãŒå¯èƒ½
- å‚è€ƒURL
  - https://python.langchain.com/api_reference/langchain/retrievers/langchain.retrievers.ensemble.EnsembleRetriever.html
  - https://python.langchain.com/docs/how_to/ensemble_retriever/

---

## Rerank
- Hybrid Searchã§ã¯ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã¨ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®ä¸¡æ–¹ã‚’ä½¿ã£ã¦å€™è£œã‚’å–å¾—ã—ã€**ãã®å¾Œã«Rerank modelã‚’ä½¿ã£ã¦ã€ä¸¦ã³ç›´ã™æ‰‹æ³•ãŒã‚ˆãä½¿ã‚ã‚Œã‚‹ã€‚**
- LLMã¯Transformerã®Decoderéƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ãŒã€Embeddingãƒ¢ãƒ‡ãƒ«ã¨Rerankãƒ¢ãƒ‡ãƒ«ã¯Transformerã®Encoderéƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã€‚
- Rerankãƒ¢ãƒ‡ãƒ«ã¨Embeddingãƒ¢ãƒ‡ãƒ«ã¯Encoderéƒ¨åˆ†ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã®ã¯å…±é€šã—ã¦ã„ã‚‹ãŒã€è¨“ç·´æ–¹æ³•ã‚„ç›®çš„ãŒç•°ãªã‚‹ã€‚
- Embeddingãƒ¢ãƒ‡ãƒ«ã¯ã€ã‚¯ã‚¨ãƒªã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ¥ã€…ã®Encoderã«é€šã—ã¦ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã€ãã®ãƒ™ã‚¯ãƒˆãƒ«é–“ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ã™ã‚‹ã‚ˆã†ã«è¨“ç·´ã•ã‚Œã¦ã„ã‚‹ã€‚  
  ä¸€æ–¹ã€Rerankãƒ¢ãƒ‡ãƒ«ã¯ã€ã‚¯ã‚¨ãƒªã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’1ã¤ã®Encoderã«åŒæ™‚ã«å…¥åŠ›ã—ã€ä¸¡è€…ã®ãƒˆãƒ¼ã‚¯ãƒ³é–“ã®ç›¸äº’ä½œç”¨ã‚’é€šã˜ã¦é–¢é€£åº¦ã‚¹ã‚³ã‚¢ã‚’ç›´æ¥å‡ºã™ã‚ˆã†ã«è¨“ç·´ã•ã‚Œã¦ã„ã‚‹ã€‚
  ![](./image/embedding_vs_rerank.jpg)