# Ginにおけるテストの書き方

## 基本構成

Ginのハンドラをテストする際は、実際のHTTPサーバーを起動せずに、以下の3つを組み合わせてテストを行う。

1. `gin.SetMode(gin.TestMode)` — デバッグログを抑制
2. `httptest.NewRecorder()` — レスポンスを記録
3. `gin.CreateTestContext(w)` — テスト用コンテキストを生成

## 各要素の説明

### `httptest.NewRecorder()`

Go標準ライブラリ `net/http/httptest` が提供する、`http.ResponseWriter` インターフェースを実装したレスポンス記録用オブジェクトを生成する関数。実際のHTTPサーバーを起動せずに、ハンドラが書き込んだレスポンスをキャプチャできる。

```go
w := httptest.NewRecorder()
```

テスト後に以下のフィールドでアサーションが可能。

| フィールド | 型 | 内容 |
|---|---|---|
| `w.Code` | `int` | HTTPステータスコード |
| `w.Body` | `*bytes.Buffer` | レスポンスボディ |
| `w.Header()` | `http.Header` | レスポンスヘッダー |

### `gin.CreateTestContext(w)`

テスト用の `*gin.Context` を生成するヘルパー関数。引数に `httptest.NewRecorder()` で作成した `ResponseRecorder` を渡す。

```go
w := httptest.NewRecorder()
c, r := gin.CreateTestContext(w)
```

| 戻り値 | 型 | 用途 |
|---|---|---|
| `c` | `*gin.Context` | ハンドラに渡すコンテキスト。リクエストの設定やレスポンスの書き込みに使用 |
| `r` | `*gin.Engine` | テスト用ルーターエンジン。ミドルウェアやルートの登録に使用 |

### `httptest.NewRequest()`

Go標準ライブラリ `net/http/httptest` が提供するテスト用HTTPリクエスト生成関数。生成したリクエストを `c.Request` に設定することで、ハンドラが参照するリクエスト情報を制御できる。

```go
req := httptest.NewRequest(http.MethodPost, "/test", bytes.NewBufferString(`{"key":"value"}`))
req.Header.Set("Content-Type", "application/json")
c.Request = req
```

## テストの実装例

以下は、Lokiのクエリリクエストをバインドする関数 `bindLokiRequest` のテスト例。JSONボディとクエリパラメータの両方のバインディング、バリデーションエラーのケースをテーブル駆動テストで網羅している。

```go
func Test_bindLokiRequest(t *testing.T) {
    gin.SetMode(gin.TestMode)

    tests := []struct {
        name        string
        contentType string
        body        string
        query       string
        wantErr     bool
        wantSID     string
        wantQuery   string
    }{
        {
            name:        "JSON body binding",
            contentType: "application/json",
            body:        `{"sid": "test-sid", "query": "{app=\"nginx\"}"}`,
            wantErr:     false,
            wantSID:     "test-sid",
            wantQuery:   `{app="nginx"}`,
        },
        {
            name:      "Query parameters binding",
            query:     "sid=test-sid&query={app=\"nginx\"}",
            wantErr:   false,
            wantSID:   "test-sid",
            wantQuery: `{app="nginx"}`,
        },
        {
            name:        "Missing required field in JSON",
            contentType: "application/json",
            body:        `{"sid": "test-sid"}`,
            wantErr:     true,
        },
        {
            name:    "Missing required field in query",
            query:   "sid=test-sid",
            wantErr: true,
        },
        {
            name:    "Empty request",
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            w := httptest.NewRecorder()
            c, _ := gin.CreateTestContext(w)

            // リクエスト作成
            url := "/test"
            if tt.query != "" {
                url += "?" + tt.query
            }

            var req *http.Request
            if tt.body != "" {
                req = httptest.NewRequest(http.MethodPost, url, bytes.NewBufferString(tt.body))
                req.Header.Set("Content-Type", tt.contentType)
            } else {
                req = httptest.NewRequest(http.MethodGet, url, nil)
            }
            c.Request = req

            // テスト対象実行
            var request LokiQueryRangeRequest
            err := bindLokiRequest(c, &request)

            if tt.wantErr {
                assert.Error(t, err)
            } else {
                assert.NoError(t, err)
                assert.Equal(t, tt.wantSID, request.SID)
                assert.Equal(t, tt.wantQuery, request.Query)
            }
        })
    }
}
```

## テスト実装のポイント

### テーブル駆動テスト

Go の慣例に従い、`[]struct` でテストケースを定義し `t.Run` でサブテストとして実行する。テストケースの追加が容易で、各ケースの意図が `name` フィールドで明確になる。

### リクエストの組み立て方

- **JSONボディ**: `httptest.NewRequest` の第3引数にボディを渡し、`Content-Type` ヘッダーを設定する
- **クエリパラメータ**: URLに `?key=value&key2=value2` の形式で付与する
- **パスパラメータ**: `c.Params` に直接設定する

```go
// パスパラメータの設定例
c.Params = gin.Params{{Key: "id", Value: "123"}}
```

### レスポンスの検証

ハンドラがレスポンスを書き込む場合は、`httptest.NewRecorder()` の `w` を通じて検証する。

```go
// ステータスコードの検証
assert.Equal(t, http.StatusOK, w.Code)

// レスポンスボディの検証
assert.Contains(t, w.Body.String(), "expected")

// JSONレスポンスの検証
var response map[string]string
json.Unmarshal(w.Body.Bytes(), &response)
assert.Equal(t, "value", response["key"])
```