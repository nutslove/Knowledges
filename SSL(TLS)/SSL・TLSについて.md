##### 参照URL
- https://blog.naver.com/alice_k106/221468341565  
- https://go-journey.club/archives/7519

##### その他
- PKI (Public Key Infrastructure)とは、公開鍵暗号方式に基づいて、電子署名や相手認証等を実現するための技術基盤
- 現在はTLS 1.3が主流
- 共通鍵暗号方式(対称鍵暗号方式)の方が公開鍵暗号方式(非対称鍵暗号方式)より処理速度が早い。  
  なのでTLS handshakeにて最初に公開鍵暗号方式でサーバ/クライアント間で共通鍵を生成/交換した後、実際のデータのやり取り時は共通鍵を使って暗号化/復号化を行う。
- Root証明書 = CA(認証局)の公開鍵
- 暗号化/復号化は公開鍵/秘密鍵どちらでもできる
  - 公開鍵で暗号化して秘密鍵で復号化、秘密鍵で暗号化して公開鍵で復号化、どちらも可

##### Hash関数
- 一方向性関数
  - inputからoutputを出すことはできるけど、outputからinputを導き出すことはできない(難しい)関数
- いかなる長さのデータを入力しても(inputデータ短くても長くても)固定長の擬似乱数データを出力(output)する関数
- データの完全性(データが改ざんされてないこと)を確認するのに良く使われる
- Hash関数で得られた値をHash値(もしくはMD(Message Digest))という

## ディジタル証明書(サーバ証明書)の発行からディジタル証明書を使った通信の流れ
#### ディジタル証明書(サーバ証明書)の発行
1. まずサーバ(事業者)側で秘密鍵/公開鍵を生成する
2. 使用したいドメイン(ex. amazon.com)と公開鍵をCA(認証局)に送ってディジタル証明書を要請する
3. CAは事業者を検証し本当にその事業者からの要請か確認してから、ディジタル証明書を生成して自身(CA)の秘密鍵でディジタル証明書のHash値を署名(暗号化)する
   - このディジタル証明書には**どのWebサイト(ex. amazon.com)で有効な証明書なのかの情報**と**サーバ(事業者)の公開鍵**と**すべての情報のHash値(CAの秘密鍵で暗号化)**が含まれる
   - ディジタル証明書の形式(規格)が`X.509`
   - このディジタル証明書の有効期限が
#### ディジタル証明書を使った通信の流れ
1. クライアントがWebサイト(ex. amazon.com)に接続するとサーバからディジタル証明書(サーバ証明書)が送られる
2. ディジタル証明書を受け取ったクライアントはブラウザに内蔵されている該当CAの公開鍵(Root証明書)で復号化する
   > **Note**  
   > 各ブラウザには信頼できるCAのリストと各CAの公開鍵(Root証明書)が内蔵されている  
   > ※*各CAから公開鍵(Root証明書)をダウンロードしてブラウザに登録することもできる（オンプレ上のブラウザ等）*
3. 該当CAの公開鍵(Root証明書)で復号化できれば、ディジタル証明書が該当CAによって署名/発行されたということが確認できる
4. クライアントは任意のデータをサーバに送る
5. サーバはクライアントから送られてきた任意のデータを自身の秘密鍵で暗号化してクライアントに返す
6. クライアントはサーバのディジタル証明書に含まれている公開鍵でデータを復号化し、復号化できれば通信相手が偽物ではないことを確認できる
7. クライアントは共通鍵を生成して、ディジタル証明書に含まれている公開鍵で暗号化しサーバに送る
8. サーバはクライアントから送られてきた暗号化されてる共通鍵を自身の秘密鍵で復号化する
   > **Note**  
   > クライアントが生成した共通鍵を**Session Key**とも呼ぶ
9.  以降クライアントとサーバはこの共通鍵(Session Key)を使ってデータを暗号化/復号化してやり取りをする

## ディジタル証明書について
#### 

#### ディジタル証明書の構造
1. Root

## TLS handshake
- 参照URL
  - https://www.cloudflare.com/ja-jp/learning/ssl/what-happens-in-a-tls-handshake/
- TLS handshakeはTLS暗号化を使った通信セッションを始めるプロセス
- TLS handshakeの間通信する二者がメッセージをやり取りして互いを認識し、検証し、使用する暗号化アルゴリズムを決定し、Session Keyについて合意する
  - 使用するTLSのバージョン（TLS 1.2、1.3など）を指定
  - 使用する暗号スイート[^1]を決定
  - サーバー公開鍵とSSL証明書認証局のデジタル署名を介して、サーバーのIDを認証
  - handshake完了後に対称暗号化[^2]に使うためのSession Keyを生成  
    [^1]:鍵交換や暗号化方式、ハッシュ関数など暗号化通信に使われる各種アルゴリズムの組合せ
    [^2]:対称暗号化方式 ⇒ 共通鍵暗号方式  
    非対称暗号化方式 ⇒ 公開鍵暗号方式
- TLS handshakeはTCP handshakeでTCP接続が開かれた後に行われる
  ![TLS handshake](https://github.com/nutslove/Knowledges/blob/main/SSL(TLS)/image/TLS-handshake.jpg)

#### ■ TLS handshakeの具体的な手順
  使用される鍵交換アルゴリズムの種類と、両側でサポートする暗号スイートによって異なる。<br>ここでは最も頻繁に使われる**RSA鍵交換アルゴリズム**のケースで説明  
1.  **「Client Hello」メッセージ**  
  クライアントがサーバーに「Hello」というメッセージを送信することによってhandshakeを開始する。このメッセージには、クライアントがサポートするTLSのバージョン、対応する暗号スイート、「クライアントランダム」というランダムなバイト文字列が含まれている。
2.  **「Server Hello」メッセージ**  
  Client Helloメッセージへの返答として、サーバーがメッセージを送る。このメッセージには、サーバーのSSL証明書、選んだ暗号スイート、サーバーが生成した別のバイト文字列「サーバーランダム」が含まれている。
3. **認証**  
  クライアントはサーバーのSSL証明書を発行元の認証局に確認する。これにより、サーバーが自称する本人に間違いなく、クライアントはそのドメインの実際の所有者とやりとりしていることが確認される。
4. **プレマスタシークレット**  
     
